<!DOCTYPE html>
<html lang="{{ lang }}">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{{ text.results_title }}</title>
    <link
      href="{{ url_for('static', filename='output.css') }}"
      rel="stylesheet"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", sans-serif;
      }
    </style>
  </head>
  <body class="bg-gray-50">
    <div class="flex flex-col justify-center items-center min-h-screen p-4">
      <div
        class="w-full max-w-4xl p-6 sm:p-8 space-y-8 bg-white rounded-2xl shadow-lg"
      >
        <div class="text-center">
          <h1 class="text-3xl font-bold text-gray-900">
            {{ text.results_title }}
          </h1>
          <p class="mt-2 text-gray-600">
            {{ text.results_subtitle.format( algorithm=algorithm.upper(),
            fitness='<strong class="text-indigo-600">%.4f</strong>' % fitness )
            | safe }}
          </p>
        </div>
        <div>
          <h3 class="text-xl font-semibold text-gray-800 text-center mb-4">
            {{ text.recommended_menu }}
          </h3>
          <div class="space-y-6">
            {% set ns = namespace(counter=0) %} {% for meal, foods in
            structured_plan.items() %}
            <div class="p-5 border border-gray-200 rounded-lg bg-gray-50/50">
              <h3 class="text-lg font-semibold text-gray-800">{{ meal }}</h3>
              <ul class="mt-3 list-disc list-inside text-gray-700 space-y-2">
                {% for food_item, portion in foods %}
                <li>
                  <span class="font-medium text-gray-900">{{ food_item }}</span>
                  ({{ portion }} porsi)
                </li>
                {% endfor %}
              </ul>
            </div>
            {% endfor %}
          </div>
          <p class="text-center text-sm text-gray-500 italic mt-4">
            {{ text.porsi_note }}
          </p>
        </div>
        <div class="space-y-8 pt-4">
          <div>
            <h3 class="text-xl font-semibold text-gray-800 border-b pb-2 mb-3">
              {{ text.profile_title }}
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
              <div class="space-y-2 text-gray-700">
                <p>
                  <strong>{{ text.profile_age }}:</strong> {{ user_profile.age
                  }} years
                </p>
                <p>
                  <strong>{{ text.profile_weight }}:</strong> {{
                  user_profile.weight_kg }} kg
                </p>
                <p>
                  <strong>{{ text.profile_height }}:</strong> {{
                  user_profile.height_cm }} cm
                </p>
                <p>
                  <strong>{{ text.profile_trimester }}:</strong> {{
                  user_profile.trimester }}
                </p>
                <div>
                  <strong>{{ text.profile_conditions }}:</strong>
                  {% set conditions = [] %} {% for condition, present in
                  user_profile.medical_conditions.items() %} {% if present %}{%
                  set _ = conditions.append(condition) %}{% endif %} {% endfor
                  %} {% if conditions|length > 0 %}
                  <ul class="list-disc list-inside pl-4 mt-1">
                    {% for c in conditions %}
                    <li>{{ text[c] }}</li>
                    {% endfor %}
                  </ul>
                  {% else %}<span class="pl-2">-</span>{% endif %}
                </div>
              </div>
              <div class="text-sm text-gray-600 bg-gray-50 p-4 rounded-lg">
                <h4 class="font-semibold text-gray-800 mb-2">
                  {{ text.important_notes }}:
                </h4>
                <ul class="list-disc list-inside space-y-2">
                  <li>{{ text.note_water }}</li>
                  {% if user_profile.medical_conditions.inflammation %}
                  <li>{{ text.note_inflammation }}</li>
                  {% endif %}
                  <li>{{ text.note_consult }}</li>
                </ul>
              </div>
            </div>
          </div>
          <div>
            <h3 class="text-xl font-semibold text-gray-800 border-b pb-2 mb-3">
              {{ text.analysis_title }}
            </h3>
            <div class="max-h-96 overflow-y-auto">
              <table class="w-full text-sm">
                <thead
                  class="text-xs text-gray-700 uppercase bg-gray-100 sticky top-0"
                >
                  <tr>
                    <th class="px-4 py-2 text-left">{{ text.nutrient }}</th>
                    <th class="px-4 py-2 text-right">{{ text.your_need }}</th>
                    <th class="px-4 py-2 text-right">{{ text.plan_total }}</th>
                    <th class="px-4 py-2 text-right">{{ text.difference }}</th>
                    <th class="px-4 py-2 text-right">{{ text.deviation }}</th>
                  </tr>
                </thead>
                <tbody>
                  {% for item in comparison_data %} {% set p_diff =
                  (item.difference|abs / (item.target + 1e-6)) * 100 %} {% if
                  p_diff < 5 %}{% set diff_color = 'text-green-600' %} {% elif
                  p_diff <= 20 %}{% set diff_color = 'text-orange-500' %} {%
                  else %}{% set diff_color = 'text-red-600' %}{% endif %}
                  <tr class="border-b">
                    <td class="px-4 py-2 font-medium text-left">
                      {{ item.nutrient }}
                    </td>
                    <td class="px-4 py-2 text-right">
                      {{ '%.2f'|format(item.target) }}
                    </td>
                    <td class="px-4 py-2 text-right">
                      {{ '%.2f'|format(item.actual) }}
                    </td>
                    <td class="px-4 py-2 text-right font-semibold">
                      {{ '%+.2f'|format(item.difference) }}
                    </td>
                    <td
                      class="px-4 py-2 text-right font-semibold {{ diff_color }}"
                    >
                      ({{ '%.1f'|format(p_diff) }}%)
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
        <div class="pt-4">
          <h3
            class="text-xl font-semibold text-gray-800 text-center border-b pb-2 mb-4"
          >
            {{ text.performance_title }}
          </h3>
          <div
            class="flex flex-col space-y-4 text-center sm:flex-row sm:space-y-0 sm:justify-around"
          >
            <div>
              <p class="text-2xl font-bold text-indigo-600">
                {{ '%.2f'|format(metrics.mape) }}%
              </p>
              <p class="text-sm text-gray-600">MAPE</p>
            </div>
            <div>
              <p class="text-2xl font-bold text-indigo-600">
                {{ '%.2f'|format(metrics.smape) }}%
              </p>
              <p class="text-sm text-gray-600">SMAPE</p>
            </div>
            <div>
              <p class="text-2xl font-bold text-indigo-600">
                {{ '%.4f'|format(metrics.r2) }}
              </p>
              <p class="text-sm text-gray-600">{{ text.r2_score }}</p>
            </div>
          </div>
        </div>
        <div class="text-center text-xs text-gray-500 pt-4 border-t">
          <p>{{ text.data_source }}</p>
          <a
            href="/static/food_dataset.csv"
            download="TKPI_2019_Dataset.csv"
            class="text-indigo-600 hover:underline"
            >{{ text.download_dataset }}</a
          >
        </div>
        <div class="text-center pt-4">
          <a
            href="/?lang={{ lang }}"
            class="inline-block px-8 py-3 font-semibold text-white bg-indigo-600 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
          >
            {{ text.generate_another }}
          </a>
        </div>
      </div>
    </div>
  </body>
</html>
